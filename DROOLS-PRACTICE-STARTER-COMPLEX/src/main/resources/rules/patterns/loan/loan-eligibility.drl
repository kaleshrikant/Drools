package rules.patterns.loan;

import com.kaleshrikant.patterns.loan.model.Customer;
import com.kaleshrikant.patterns.loan.model.Account;
import com.kaleshrikant.patterns.loan.model.Transaction;
import com.kaleshrikant.patterns.loan.model.Application;

// ðŸŒ GLOBAL VARIABLES
global java.util.List logCollector;

// ðŸ§® FUNCTIONS for reusable calculations
function boolean isEligible(int score, double income) {
    return score > 650 && income > 50000;
}

function double calculateRiskScore(int age, double income, int creditScore) {
    double risk = (age * 0.1) + (income * 0.0001) - (creditScore * 0.01);
    return Math.max(0, Math.min(100, risk));
}

/**
 * ðŸ“œ Comprehensive Loan Eligibility Assessment Rules - Advanced Pattern Implementation
 *
 * ðŸŽ¯ Purpose: Evaluate customer eligibility and risk
 * ðŸ” Patterns: Multi-object matching with fraud exclusion
 * ðŸ§® Functions: Risk score calculation
 */

rule "Advanced Pattern - Comprehensive Loan Eligibility Assessment Rules"
    when
        $customer : Customer(status == "ACTIVE")
        exists(Account(customerId == $customer.id, balance > 1000))
        not(Transaction(customerId == $customer.id, type == "FRAUD"))
    then
        logCollector.add("ðŸ” Complex pattern matched for: " + $customer.getName());

        double risk = calculateRiskScore($customer.getAge(), $customer.getIncome(), $customer.getCreditScore());
        logCollector.add("ðŸ“Š Risk score calculated: " + risk);

        if (isEligible($customer.getCreditScore(), $customer.getIncome())) {
            $customer.setStatus("ELIGIBLE");
            logCollector.add("âœ… " + $customer.getName() + " is eligible for loan.");
        } else {
            $customer.setStatus("REJECTED");
            logCollector.add("âŒ " + $customer.getName() + " is not eligible for loan.");
        }
end

/**
 * ðŸ“œ Accumulate Pattern Example
 *
 * ðŸŽ¯ Purpose: Detect high-value customers
 * âž• Accumulate: Sum of transaction amounts
 */

rule "Data Aggregation - Comprehensive Loan Eligibility Assessment Rules"
    when
        $customer : Customer()
        $totalTransactions : Double() from accumulate(
            Transaction(customerId == $customer.id, $amount : amount),
            sum($amount)
        )
        eval($totalTransactions > 10000)
    then
        logCollector.add("ðŸ’° High-value customer detected: " + $customer.getName());
        logCollector.add("ðŸ“ˆ Total transaction amount: " + $totalTransactions);
end

/**
 * ðŸ“œ Conditional Logic Pattern
 *
 * ðŸŽ¯ Purpose: Evaluate multi-constraint domain object
 * ðŸ” Patterns: In-list, numeric, and regex constraints
 */

rule "Complex Conditions - Comprehensive Loan Eligibility Assessment Rules"
    when
        $customer : Customer(
            status in ("ACTIVE", "PENDING"),
            income >= 50000,
            name matches "^[A-Z].*"
        )
    then
        logCollector.add("ðŸ§  Complex conditions satisfied for: " + $customer.getId());
        $customer.setStatus("VALIDATED");
end
